---
title: "Weekly_Data_Processing"
author: "Benny Rice"
date: "2/8/2021"
output: html_document
---

```{r setup, include = FALSE, eval = TRUE, echo = TRUE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

***
***
<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

## HEADER INFO

- Benny Rice | Department of Ecology and Evolutionary Biology | Princeton University | b.rice@princeton.edu
- Code associated with processing data from the **Impacts of Covid-19 on Malagasy STEM** project
- Apologies in advance for amateurish code (ie all the loops and clunkiness)
- In colloboration with Lova Marline, Miary Raselimanana, Seheno Andriantsaralaza, Hervet Randriamady

</div>

***

(Set up: Loading necessary libraries)
```{r i1, message = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggplot2)
library(reshape2)
library(ggpubr)
library(ggalt)
library(ggrepel)
library(here)
library(gridExtra)
library(readxl)
```

***
***

#### OUTLINE:

- **Section 1 |** Reading in data downloaded from Kobo Collect
- **Section 2 |** Cleaning data (in progress)
- **Section 3 |** Progress summaries: Summary stats and sampling time series
- **Section 4 |** Preliminary data visualizations: Breakdown by gender
- **Section 5 |** ...



**FIX** Update outline at the end (add figures and tables interspersed ^)


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 1 | Reading in data downloaded from Kobo Collect (xls form, English)

</div>

***
***

- Data is read from an xlsx file that is manually downloaded from the Kobo Collect account
  - [KoBoToolbox](https://kf.kobotoolbox.org/#/forms) --> `Impacts of Covid-19 on Malagasy STEM` --> `DATA` --> `Downloads`
  - Selecting export options:
    - Export type `XLS`
    - Value and header format `XML values and headers`
    - `Advanced options`: Select `Include fields from all 32 deployed versions`
      - Note this will include a series of columns at the far end corresponding to changed questions
      - Note: Manually delete the "other_info" column
        - This column contains a free text response from respondents; deleted in case there is personal info within
  - Manually uploading to [the GitHub repository for this project](https://github.com/labmetcalf/COVID_STEM_MADA)
- Data file name should include the date at which data was downloaded

```{r 1.01}
k.data <- read_xlsx(here("DATA_07_Impacts_of_Covid-19_on_Malagasy_STEM_-_all_versions_-_False_-_2021-05-01-13-20-40.xlsx"))
```


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 2 | Cleaning data (in progress)

</div>

***
***

#### Section 2.1 | Cleaning up "other" responses

Questions with "other" responses:

1. Field of study (`other_field`)
2. Academic stage / position (`other_acad`)
3. Type of institution (`other_inst`)
4. Challenges to attend online opportunities (`other_challenge_opport`)T
  
- Changing text responses by hardcoding following the tables below

***

**1. Field of study**

- Listing other responses

```{r 2.01.1, echo = FALSE}
paste0("Number of unique other responses: ", length(unique(tolower(k.data$other_field))) - 1)
unique(tolower(k.data$other_field[!is.na(k.data$other_field)]))
```

##### Original options and cleaned groupings:

| code                   | full text                                   | field_cleaned                       |
| ---------------------- | ------------------------------------------- | ----------------------------------- |
| agri_natres            | Agriculture & Natural Resources             | Agriculture & Natural Resources     |
| agro                   | Agronomic Sciences                          | Agriculture & Natural Resources     |
| astro	                 | Astronomy & Astrophysics                    | Physical Sciences                   |
| atmo_earth_ocean       | Atmospheric, Earth & Ocean Sciences         | Atmospheric, Earth & Ocean Sciences |
| biochem_cell_mol_biolo | Biochemistry, Cellular & Molecular Biology  | Biological Sciences                 |
| bio_sci                | Biological Sciences                         | Biological Sciences                 |
| chem_chemeng           | Chemistry & Chemical Engineering            | Physical Sciences                   |
| clinicsci              | Clinical Sciences                           | Clinical & Health Sciences          |
| comp_scien             | Computer Science                            | Computer Science                    |
| eletc_mech             | Electrical & Mechanical Engineering         | Engineering Sciences                |
| enviro                 | Environmental Science                       | Environmental Sciences              |
| health_sci             | Health Sciences                             | Clinical & Health Sciences          |
| math_stat              | Mathematics & Statistics                    | Mathematics & Statistics            |
| pharm_cosmet           | Pharmacology, Physiology & Cosmetology      | Clinical & Health Sciences          |
| physic                 | Physics                                     | Physical Sciences                   |
| other_eng	             | Other Engineering Sciences                  | Engineering Sciences                |
| nonstem                | Non-STEM field                              | Non-STEM                            |

##### Cleaned codes

| code                   | code_cleaned | field_cleaned                       |
| ---------------------- | ------------ | ----------------------------------- |
| agri_natres            | agro_sci     | Agriculture & Natural Resources     |
| agro                   | agro_sci     | Agriculture & Natural Resources     |
| comp_scien             | comp_sci     | Computer Science                    |
| atmo_earth_ocean       | earth_sci    | Atmospheric, Earth & Ocean Sciences |
| eletc_mech             | engi_sci     | Engineering Sciences                |
| other_eng	             | engi_sci     | Engineering Sciences                |
| enviro                 | env_sci      | Environmental Sciences              |
| health_sci             | health_sci   | Clinical & Health Sciences          |
| pharm_cosmet           | health_sci   | Clinical & Health Sciences          |
| clinicsci              | health_sci   | Clinical & Health Sciences          |
| biochem_cell_mol_biolo | life_sci     | Biological Sciences                 |
| bio_sci                | life_sci     | Biological Sciences                 |
| math_stat              | math_stats   | Mathematics & Statistics            |
| astro	                 | phys_sci     | Physical Sciences                   |
| chem_chemeng           | phys_sci     | Physical Sciences                   |
| physic                 | phys_sci     | Physical Sciences                   |
| nonstem                | non_stem     | Non-STEM                            |

```{r 2.01.2, echo = FALSE}
#Replacing other responses with code from original options
k.data <- k.data %>% mutate(other_field = tolower(other_field)) %>%
  mutate(other_field = recode(other_field,
    "géologie"                           = "atmo_earth_ocean",
    "hydrosciences"                      = "atmo_earth_ocean",
    "sciences agronomiques"              = "agri_natres",
    "pharmacologie"                      = "health_sci",
    "pharmacology"                       = "health_sci",
    "pharmacologie et cosmétologie"      = "health_sci",
    "nutrition"                          = "health_sci",
    "pharmarmacologie, cosmetic"         = "health_sci",
    "sciences et technique nucleaires"   = "physic",
    "sciences et techniques nucléaires"  = "physic",
    "ecotourism science"                 = "enviro",
    "paléontologie"                      = "bio_sci",
    "science et technologie"             = "comp_sci",
    "paleontology"                       = "bio_sci",
    "marine biology"                     = "bio_sci",
    "administration"                     = "nonstem",
    "marine science"                     = "atmo_earth_ocean",
    "animal health sciences"             = "bio_sci",
    "etudes envionnementales en général" = "enviro",
    "zoology"                            = "bio_sci",
    "entomologie"                        = "bio_sci",
    "physique nucléaire"                 = "physic",
    "économie de la santé"               = "health_sci",
    "géographie"                         = "atmo_earth_ocean",
    "science de la terre"                = "atmo_earth_ocean",
    "science de la nature et de l'ecosystème"                 = "enviro",
    "sciences nucleaires, physiques, nanotechnologie"         = "physic",
    "sciences techniques nucleaires et nanotechnologie"       = "physic",
    "sciences de l'environnement et du développement durable" = "enviro"
    ))
```

***

**2. Academic stage / position**


- Listing other responses

```{r 2.02.1, echo = FALSE}
paste0("Number of unique other responses: ", length(unique(tolower(k.data$other_acad))) - 1)
unique(tolower(k.data$other_acad[!is.na(k.data$other_acad)]))
```

##### Original options and cleaned groupings:

| code                   | full text                                           | field_cleaned                |
| ---------------------- | --------------------------------------------------- | ---------------------------- |
| master_student         | Master's student                                    | Masters Student              |
| masterstud             | Master's student                                    | Masters Student              |
| phdcandidate_student   | PhD candidate or student                            | PhD Student                  |
| phd_stud               | PhD candidate or student                            | PhD Student                  |
| postgrad               | Post-graduate student                               | Postgraduate Student         |
| postdoc                | Postdoctoral researcher                             | Postdoc                      |
| research_assist        | Research assistant                                  | Research Assistant or Tech   |
| instructor             | Faculty member, Professor, or University Instructor | Faculty, PI, or Senior Level |
| consult                | Consultant                                          | STEM Professional            |
| research_officer       | Research officer                                    | STEM Professional            |
| independent_researcher | Independent researcher                              | STEM Professional            |
| retired_scientist      | Retired scientist (No longer engaged in research)   | Retired scientist            |
| NA_not_eligible        | Not eligible                                        | Not eligible                 |

##### Cleaned codes

| code                   | code_cleaned | field_cleaned                |
| ---------------------- | -------------|----------------------------- |
| master_student         | student_ms   | Masters Student              |
| masterstud             | student_ms   | Masters Student              |
| phdcandidate_student   | student_phd  | PhD Student                  |
| pdhstud                | student_phd  | PhD Student                  |
| postgrad               | postgrad     | Postgraduate Student         |
| postdoc                | postdoc      | Postdoc                      |
| research_assist        | ra_tech      | Research Assistant or Tech   |
| instructor             | senior_pi    | Faculty, PI, or Senior level |
| consult                | staff_res    | STEM Professional            |
| research_officer       | staff_res    | STEM Professional            |
| independent_researcher | staff_res    | STEM Professional            |
| retired_scientist      | ret_sci      | Emeritus                     |
| NA_not_eligible        | NA_inelig    | Not eligible                 |


```{r 2.02.2, echo = FALSE}
#Replacing other responses with code from original options
k.data <- k.data %>% mutate(other_acad = tolower(other_acad)) %>%
  mutate(other_acad = recode(other_acad,
    "medicin"                              = "research_officer",
    "médecin"                              = "research_officer",
    "professeur"                           = "instructor",
    "etudiante en licence"                 = "NA_not_eligible",           #Not eligible, still an undergrad
    "directeur général"                    = "instructor",
    "président gerp"                       = "instructor",
    "fonctionnaire de l'état"              = "research_officer",
    "professeur titulaire"                 = "instructor",
    "clo multidisciplinaire"               = "research_officer",
    "formation spécialisée"                = "research_officer",
    "chercheur biologiste"                 = "research_officer",
    "travailleur"                          = "research_officer",
    "monitoring and evaluation"            = "research_officer",
    "suivi évaluation"                     = "research_officer",
    "cco  (biologiste preleveur)"          = "research_officer",
    "chef de volet conservation"           = "instructor",
    "travailleurs"                         = "research_officer",
    "thesard doctorat d'exercice"          = "phd_stud",
    "responsable technique"                = "research_officer",
    "secrétaire de direction"              = "research_officer",
    "secrétaire"                           = "research_officer",
    "technicienne de surface"              = "research_assist",
    "responsable environnement"            = "research_officer",
    "responsable ictc"                     = "research_officer",
    "en recherche de finacement"           = "research_officer",
    "recently graduate"                    = "postgrad",
    "ministre"                             = "instructor",
    "aucun"                                = "postgrad",
    "directeur du parc"                    = "instructor",
    "directeur"                            = "instructor",
    "salariée"                             = "research_officer",
    "enseignant vacataire"                 = "phd_stud",
    "responsable laborat"                  = "research_officer",
    "responsable d'hygiène"                = "research_officer",
    "enseignante vacataire"                = "phd_stud",
    "entrepreneur"                         = "consult",
    "technicien de production"             = "research_assist",
    "graduate"                             = "postgrad",
    "assistant d'enseignement supérieur"   = "research_assist",
    "ingénieur de maintenance"             = "research_officer",
    "cadre dans une entreprise"            = "instructor",
    "enseignant-chercher (vacataire)"      = "instructor",
    "technicien de laboratoire"            = "research_assist",
    "enseignant vacataire,  consultant"    = "research_officer",
    "chef de projet dans la conservation"  = "instructor",
    "enseignant vacataire-informaticien"   = "phd_stud",
    "coordinateur de projet"               = "research_officer",
    "chargé d'études environnementales"    = "research_officer",
    "coordinatrice de projet"              = "research_officer",
    "master ii"                            = "master_student",
    "chercheur, chef d'unité"              = "instructor",
    "practitioner in marine conservation"  = "research_officer",
    "chef service administratif et financier"     = "research_officer",
    "responsable production et environnement"     = "research_officer",
    "respo admin personnel et juridique"          = "research_officer",
    "cadre dans un projet de développement"       = "research_officer",
    "i still study at the undergraduate level"    = "NA_not_eligible",         #Not eligible, still an undergrad
    "gestionnaire de site aires protégées marine" = "research_officer",
    "gestionnaire aire protégée"                  = "research_officer",
    "coordinatrice d'étude clinique"              = "research_officer",
    "socio-organisateur dans ong blue ventures"   = "research_officer",
    "manager en éducation environnementale"       = "research_officer",
    "en cours de preparation de l'inscription au doctorat" = "postgrad",
    "administration (asity) et responsable de formation"   = "research_officer",
    "i am recently graduated and would like to wait a while before continuing my study" = "postgrad"
    ))

#Removing ineligible participants (e.g., still undergraduate students)
# Keeping rows where other_acad = NA (participant selected one of the standard options)
k.data <- k.data %>% filter(is.na(other_acad) | other_acad != "NA_not_eligible")

```

***

**3. Type of institution**

##### Listing other responses

```{r 2.03.1, echo = FALSE}
paste0("Number of unique other responses: ", length(unique(tolower(k.data$other_inst))) - 1)
unique(tolower(k.data$other_inst[!is.na(k.data$other_inst)]))
```

##### Original options and cleaned groupings:

| code         | full text                                           | field_cleaned        |
| ------------ | --------------------------------------------------- | -------------------- |
| univ         | University (public / private)                       | University           |
| ngo          | NGO / Association                                   | NGO                  |
| gov_pub_agen | Government ministry / Government agency             | Governmental Agency  |
| lab          | Laboratory / Research center / Research group       | Research Institution |
| priv_inst    | Private company                                     | Private Company      |
| none         | None of the above                                   | Independent          |

```{r 2.03.2, echo = FALSE}
#Replacing other responses with code from original options
k.data <- k.data %>% mutate(other_inst = tolower(other_inst)) %>%
  mutate(other_inst = recode(other_inst,
    "protection de l'environnement" = "univ",
    "pnud/gef"                      = "ngo",
    "independent"                   = "none",
    "homeopharma"                   = "priv_inst",
    "ist ampasampito"               = "univ",
    "ist"                           = "univ",
    "stem4good"                     = "ngo",
    "ird"                           = "lab",
    "private high school"           = "priv_inst",
    "ips"                           = "ngo",
    "centre de recherches"          = "lab",
    "bureau d'étude"                = "priv_inst",
    "organisme international"       = "ngo",
    "société  civil"                = "gov_pub_agen"
    ))
```

##### Creating cleaned, standardized columns (1s and 0s for each option)

##### Cleaned codes

| code         | code_cleaned | field_cleaned        |
| ------------ | -------------|--------------------- |
| univ         | inst_uni     | University           |
| ngo          | inst_ngo     | NGO                  |
| gov_pub_agen | inst_gov     | Governmental Agency  |
| lab          | inst_lab     | Research Institution |
| priv_inst    | inst_priv    | Private Company      |
| none         | inst_none    | Independent          |

Criteria:

***

Type of instution = University `inst_uni`: 
  1. selected institution as university (`inst/univ` == "1")
  2. selected other institution but other response is university (`other_inst == "univ"`)
  3. selected academic stage as masters or PhD student:
    - (`acad/master_student` == "1" | `acad/masterstud` == "1" | `acad/phdcandidate_student` == "1" | `acad/pdhstud` == "1")
    - Note that PhD student code was mispelled in original survey deployment: pdh not phd
  4. Note for some February 5 surveys, the columns with 1s and 0s for each option did not automatically generate
    - (`acad %in% c("master_student", "masterstud", "phdcandidate_student", "pdhstud")`) 

***

Type of institution = NGO `inst_ngo`: 
  1. selected institution as ngo (`inst/ngo` == "1")
  2. selected institution as association (`inst/assoc` == "1")
  3. selected other institution but other response is ngo (`other_inst == "ngo"`)


```{r 2.03.3, echo = FALSE}
df1 <- k.data %>% select(inst:`inst/none`, other_inst)
names(df1)
str(df1)

# 
dfx <- k.data %>%
  #inst_uni
  mutate(inst_uni = case_when(
    `inst/univ`                 == "1"    ~ 1,
     other_inst                 == "univ" ~ 1,
    `acad/master_student`       == "1"    ~ 1,
    `acad/masterstud`           == "1"    ~ 1,
    `acad/phdcandidate_student` == "1"    ~ 1,
    `acad/pdhstud`              == "1"    ~ 1,
     acad %in% c("master_student", "masterstud", "phdcandidate_student", "pdhstud") ~ 1,)) %>% 
  #inst_ngo
  mutate(inst_ngo = case_when(
    `inst/ngo`   == "1"   ~ 1,
    `inst/assoc` == "1"   ~ 1,
     other_inst  == "ngo" ~ 1)) %>%
  select(start, inst:`inst/none`, other_inst, inst_ngo)

```



***

**4. Challenges to attend online opportunities**

- Listing other responses

```{r 2.04.1, echo = FALSE}
paste0("Number of unique other responses: ", length(unique(tolower(k.data$other_challenge_opport))) - 1)
#converting to lower case, ordering by length of response
v.sor.4 <- unique(tolower(k.data$other_challenge_opport[!is.na(k.data$other_challenge_opport)]))
v.sor.4[order(nchar(v.sor.4), v.sor.4)]
```

##### Original options and cleaned groupings:

| code               | full text                     | field_cleaned            |
| ------------------ | ----------------------------- | ------------------------ |
| cost               | Costs                         | Cost                     |
| internet           | Internet access issues        | Internet Access          |
| elect              | Electricity access issues     | Electricity              |
| nocomput           | No personal computer          | Computer Access          |
| compissue          | Computer issues               | Computer Issues          |
| lackspace          | Lack of a space at home       | Lack of Space            |
| unawareoffer       | Unaware of interesting offers | Unaware of Offers        |
| lacktime           | Lack of time                  | Lack of Time             |
| language           | Language barriers             | Language Barrier         |
| anxiety_notmotiv   | Anxiety or other distractions | Anxiety and distractions |
| timezone           | Difference in time zone       | Time zone                |
| anxiety_notinteres | Not interested                | Uninterested             |
| none               | None of the above             | None                     |


##### Cleaned codes

| code               | code_cleaned | field_cleaned            |
| ------------------ | ------------ | ------------------------ |
| cost               | access_cost  | Cost                     |
| internet           | access_wifi  | Internet Access          |
| elect              | access_elec  | Electricity              |
| nocomput           | acess_comp   | Computer Access          |
| compissue          | comp_issue   | Computer Issues          |
| lackspace          | access_space | Lack of Space            |
| unawareoffer       | access_aware | Unaware of Offers        |
| lacktime           | access_time  | Lack of Time             |
| language           | lang_barrier | Language Barrier         |
| anxiety_notmotiv   | anx_motiv    | Anxiety and distractions |
| timezone           | time_zone    | Time zone                |
| anxiety_notinteres | uninterested | Uninterested             |
| none               | none         | None                     |

```{r 2.04.2, echo = FALSE}
#Replacing other responses with code from original options
k.data <- k.data %>% mutate(other_challenge_opport = tolower(other_challenge_opport)) %>%
  mutate(other_challenge_opport = recode(other_challenge_opport,
    "tsy fahaizana teny hafa"                                         = "language",
    "limitation de possibilite"                                       = "unawareoffer",
    "non maitrise des protocoles"                                     = "comp_issue",
    "cost of the internet connexion"                                  = "internet",
    "limitation du nombre de participants"                            = "unawareoffer",
    "problème des manipulation des logiciel informatique"             = "comp_issue",
    "perturbation à domicile à cause de la presence de vie familiale" = "access_space",
    "voisins et entourage bruyants, source d'incompréhension et de malaise vis à vis des interlocuteurs"  = "access_space"
    ))
```



***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 3 | Progress summaries: Summary stats and sampling time series

</div>

***
***

- Summary of sampling progress listed:

```{r 3.01, echo = FALSE}
paste0("Dates of surveys completed:")
paste0(sort(unique(k.data$today)))
paste0("Number of surveys completed (n) = ", length(k.data$agreement[k.data$agreement == "yes"]))
paste0("Number of incomplete or aborted surveys = ", sum(is.na(k.data$gender)))
paste0("Number of surveys completed, female = ", 
       length(k.data$agreement[k.data$agreement == "yes" & k.data$gender == "female"]))
paste0("Number of surveys completed, male  = ", 
       length(k.data$agreement[k.data$agreement == "yes" & k.data$gender == "male"]))
paste0("Number of surveys completed, nonbinary gender = ", 
       length(k.data$agreement[!is.na(k.data$gender) & k.data$gender == "other_notsay"]))
paste0("Average number of surveys performed per day of sampling = ",
       round(length(k.data$agreement[k.data$agreement == "yes"])/length(unique(k.data$today)), 2))
```

- Summary of sampling progress, time series plot:
```{r 3.02, echo = FALSE}
p.gender_summary1 <- k.data %>% drop_na(gender) %>% select(agreement, today, gender) %>% group_by(today) %>% 
  summarize(n = length(today), .groups = "drop") %>%
  ggplot(aes(x = today, y = n)) +
  geom_bar(stat='identity', width=0.8) +
  xlab("Date") + labs(subtitle = "Sampling by day") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

p.gender_summary2 <- k.data %>% drop_na(gender) %>% select(agreement, today, gender) %>% group_by(today) %>% 
  count(gender) %>% ungroup() %>%
  ggplot(aes(x = today, y = n, fill = gender)) +
  geom_bar(stat='identity', width=0.8) +
  xlab("Date") + 
  labs(subtitle = "Sampling by day and gender",
       fill = "") +
  scale_fill_manual(values  = c("#46055E", "#468D8A", "#F2DE24"), 
                     labels = c("Female", "Male", "Prefer not to say\nor nonbinary")) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "right")

p.gender_summary3 <- k.data %>% drop_na(gender) %>% select(agreement, today, gender) %>% group_by(today) %>% 
  summarize(n = length(today), .groups = "drop") %>% 
  mutate(n_cum = cumsum(n)) %>%
  ggplot(aes(x = today, y = n_cum)) +
  geom_bar(stat='identity', width=0.8, fill = "#ff6f00") +
  xlab("Date") + ylab ("Cumulative number of surveys completed") + labs(subtitle = "Cumulative Sampling by day") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

```

```{r 3.03, fig.height = 7, fig.width = 10}
grid.arrange(p.gender_summary1, p.gender_summary2, nrow = 1)
```

```{r 3.04, fig.height = 7, fig.width = 10}
p.gender_summary3
```


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 4 | Preliminary data visualizations: Breakdown by gender

</div>

***
***

Plotting research activity effects by gender:

```{r 4.01, echo = FALSE}
d.rae <- k.data %>% select(gender, fieldwork_affect:editpeer_affect) %>% drop_na(gender) %>% 
  filter(gender != "other_notsay")

p.rae.fieldNA <- d.rae %>% 
  group_by(gender) %>% count(fieldwork_affect) %>% ungroup() %>%
  mutate(fieldwork_affect = factor(fieldwork_affect, 
                                   levels = rev(c("na", "nochangeaffect", "slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = fieldwork_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on fieldwork by gender (with NAs)") + 
  xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "right")

p.rae.writeNA <- d.rae %>% 
  group_by(gender) %>% count(writ_affect) %>% ungroup() %>%
  mutate(writ_affect = factor(writ_affect, 
                              levels = rev(c("na", "nochangeaffect", "slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = writ_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on writing by gender (with NAs)") + 
  xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "right")

```

**Figure 4.02** Impacts of COVID-19 disruptions on fieldwork and writing by gender (including those that responded "not applicable")
```{r 4.02, fig.height=7, fig.width=10, echo=FALSE}
grid.arrange(p.rae.fieldNA, p.rae.writeNA, nrow = 1)
```

- Writing a function to create the plot for a desired research activity (e.g., `fieldwork_affect`)

```{r 4.02, echo = FALSE}
f.plot.res_act <- function(dataset, activity, activity_name){

  d.res_act <- dataset %>% select(gender, activity) %>% drop_na(gender) %>% filter(gender != "other_notsay")
  names(d.res_act) <- c("gender", "selected_activity")
  d.res_act <- d.res_act %>% group_by(gender) %>% count(selected_activity) %>% ungroup() %>%
    mutate(selected_activity = factor(selected_activity, 
                                      levels = rev(c("na", 
                                                     "nochangeaffect", 
                                                     "slightaffect", 
                                                     "modaffect",
                                                     "veryaffect")))) %>%
    filter(selected_activity != "na")

  p.res_act <- d.res_act %>% ggplot(aes(x = gender, y = n, fill = selected_activity)) +
    geom_bar(position="fill", stat='identity', width=0.8) +
    labs(title = activity_name,
         subtitle = paste0("Impact by gender among\napplicable respondents\n", "n = ", sum(d.res_act$n))) +
    xlab("Gender") + ylab("Proportion") +
    scale_fill_viridis_d(option = "inferno", direction = -1, name = "Impact: ", 
                         labels = c("Strong", "Moderate", "Slight", "None")) +
    theme_bw() +
    theme(#legend.position = "bottom", 
          legend.position = "none",
          legend.title = element_text(size = 5), 
          legend.text = element_text(size = 5))
  
  return(p.res_act)
}
```


**Figure 4.03 Impacts of COVID-19 disruptions on fieldwork, writing, and data analysis activity among Malagasy STEM by gender**
(for those respondents identifying these as applicable activities for their work or studies)

```{r 4.03, echo = FALSE}
p.rae.field <- f.plot.res_act(dataset = k.data, activity = "fieldwork_affect", activity_name <- "Fieldwork")
p.rae.write <- f.plot.res_act(dataset = k.data, activity = "writ_affect",      activity_name <- "Writing")
p.rae.datan <- f.plot.res_act(dataset = k.data, activity = "data_affect",      activity_name <- "Data Analysis")

grid.arrange(p.rae.field, p.rae.write, p.rae.datan, nrow = 1)
```




***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 5 | Preliminary data visualizations: Ranked stressors by gender

</div>

***
***

(using "slopegraphs": [example](https://charliepark.org/slopegraphs/), [example](https://acaird.github.io/computers/r/2013/11/27/slopegraphs-ggplot), [example](https://ibecav.github.io/slopegraph/))

Section 6: Stress during the coronavirus pandemic

- 1) Did you experience increased stress that related to your efficiency at work (e.g., procrastination, deadlines)? `stress_delaywork`
- 2) Did you experience increased stress related to your future career plans? `stress_career`
- 3) Did you experience increased stress related to the burden of childcare and household work? `stress_burden`
- 4) Did you experience increased stress related to your personal relationships or marriage? `stress_relation`
- 5) Did you experience increased stress related to pregnancy / access to birth control / family planning? `stress_pregbirth`
- 6) Did you experience increased stress associated with money issues (e.g., paying bills)? `stress_moneyemplo`
- 7) Did you experience increased stress related to your personal health? `stress_pershealth`
- 8) Did you experience increased stress related to the health of your family members? `stress_healthfam`
- 9) Did you experience increased stress related to social anxiety: loneliness, lack of social interaction, lack of personal space, depression, lack of physical activity? `stress_anxiety`


- Preparing data for plotting
```{r 5.01, fig.height=7, fig.width=10, echo=FALSE}
#Selecting relevant columns, dropping NAs, and nonbinary gender respondents (because n = 3)
df.stress <- k.data %>% select(age:acad, stress_delaywork:stress_relation, stress_moneyemplo:stress_anxiety) %>% 
  drop_na() %>%
  filter(gender != "other_notsay")
#Calculating the percent of respondents with moderate, strong, or extreme stress (p.ss) for each topic
df.stress.all <- df.stress %>% group_by(gender) %>% summarize(
  p.ss.delaywork  = length(which(stress_delaywork %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_delaywork),
  p.ss.career     = length(which(stress_career %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_career),
  p.ss.burden     = length(which(stress_burden %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_burden),
  p.ss.relation   = length(which(stress_relation %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_relation),
  p.ss.moneyemplo = length(which(stress_moneyemplo %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_moneyemplo),
  p.ss.pershealth = length(which(stress_pershealth %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_pershealth),
  p.ss.healthfam  = length(which(stress_healthfam %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_healthfam),
  p.ss.anxiety    = length(which(stress_anxiety %in% 
                                  c("modstress", "strongstress", "extrastress")))/length(stress_anxiety), .groups = "drop") %>%
  melt(id.vars = "gender")
#Adding more presentable labels
df.stress.all <- df.stress.all %>% mutate(label = case_when(
  variable == "p.ss.delaywork"  ~ "Interruptions/delays at work",
  variable == "p.ss.career"     ~ "Future career plans",
  variable == "p.ss.burden"     ~ "Burden of household work",
  variable == "p.ss.relation"   ~ "Personal relationships",
  variable == "p.ss.moneyemplo" ~ "Money/financial responsibilities",
  variable == "p.ss.pershealth" ~ "Personal health",
  variable == "p.ss.healthfam"  ~ "Health of family members",
  variable == "p.ss.anxiety"    ~ "Anxiety or social stress"))
```

- Plotting
```{r 5.02, fig.height=7, fig.width=10, echo=FALSE}
#Putting all the thematic changes to the plot in a list:
MySpecial <- list(  
  # move the x axis labels up top
  scale_x_discrete(position = "top"),
  theme_bw(),
  # Format tweaks
  # Remove the legend
  theme(legend.position = "none"),
  # Remove the panel border
  theme(panel.border     = element_blank()),
  # Remove just about everything from the y axis
  theme(axis.title.y     = element_blank()),
  theme(axis.text.y      = element_blank()),
  theme(panel.grid.major.y = element_blank()),
  theme(panel.grid.minor.y = element_blank()),
  # Remove a few things from the x axis and increase font size
  theme(axis.title.x     = element_blank()),
  theme(panel.grid.major.x = element_blank()),
  theme(axis.text.x.top      = element_text(size=12)),
  # Remove x & y tick marks
  theme(axis.ticks       = element_blank()),
  # Format title & subtitle
  theme(plot.title       = element_text(size=14, face = "bold", hjust = 0.5)),
  theme(plot.subtitle    = element_text(hjust = 0.5))
)

p.rs <- ggplot(data = df.stress.all, aes(x = gender, y = value, group = variable)) +
  geom_line(aes(color = variable, alpha = 1), size = 1) +
  geom_point(aes(color = variable, alpha = 1), size = 3) +
  geom_text_repel(data = df.stress.all %>% filter(gender == "female"), 
                  aes(label = paste0(label, " : ", round(value*100, 2), "%")) , 
                  hjust = "right", 
                  size = 3, 
                  nudge_x = -.45, 
                  direction = "y") +
  geom_text_repel(data = df.stress.all %>% filter(gender == "male"), 
                  aes(label = paste0(round(value*100, 2), "%")) , 
                  hjust = "right", 
                  size = 3, 
                  nudge_x = .5, 
                  direction = "y") +
  MySpecial +
  labs(
    title    = "Percent of respondents reporting moderate or greater stress related to:",
    ##Storing sample size as a variable to use in the caption to the plot below
    subtitle = paste0("n = ", length(df.stress$age)),
    caption  = "Madagascar STEM students and professionals"
  )

p.rs
```


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 6 | Preliminary data visualizations: Household and contact patterns

</div>

***
***

- Selected questions from the survey:

  - 4.04 Not including bathrooms or kitchen, how many rooms does the house you live in have? `nb_room`

  - 4.06 Household members `hh_member_count` : `age_hh_member`, `age_hh_member_001`:`age_hh_member_014`

  - 5.02 In the last week, approximately with how many people besides those in your household did you spend more than 10 minutes in close contact with? `close_contact`

(Preparing the data for plotting)

```{r 6.01, fig.height=7, fig.width=10, echo=FALSE}
#Renaming the index column (the integers counting up assigned to each submission/respondent in Kobo)
# (to use for joining later)
df.hhc <- k.data %>% rename(index = "_index") %>% 
  #Selecting relevant columns
  select(index, age, gender, region, acad, 
         nb_room,
         hh_member_count,
         close_contact) %>%
  #Converting columns to numeric
  mutate(age = as.numeric(age), nb_room = as.numeric(nb_room), hh_member_count = as.numeric(hh_member_count)) %>%
  #Adding 1 to the hh size (to include the respondent + the other members of the household)
  mutate(hh_member_count = hh_member_count + 1) %>%
  #Calculating approximate age of the respondent and storing as age_hh_memb_i
  mutate(age_hh_memb_i = 2021-age) %>%
  #Using join to add the columns containing ages of the other household members
  #Doing separately so can convert all columns to numeric using mutate_if()
  full_join(k.data %>% rename(index = "_index") %>% 
              #renaming the column with the age of the first other household member (the 2nd member of the household)
              # age_hh_memb_000
              mutate(age_hh_memb_000 = age_hh_memb) %>%
              select(index, age_hh_memb_000, age_hh_memb_001:age_hh_memb_014) %>% 
              mutate_if(is.character, as.numeric),
            by = "index") %>%
  #Subsetting to Antananarivo region Analamanga
  filter(region == "analamang") %>%
  #Removing illogical responses (e.g., 0 rooms in the house, negative number of hh members)
  #(e.g. hh_member count > 14 because didn't record ages for more than 14 individuals)
  filter(nb_room > 0) %>% filter(hh_member_count > 0) %>% filter(hh_member_count < 15) %>%
  #Calculating the number of people per room in houses
  mutate(pers_per_room = hh_member_count/nb_room) %>%
  #Determining which records have full household age data and removing incomplete records
  mutate(cols_w_age = 1 + rowSums(!is.na(select(., age_hh_memb_000:age_hh_memb_014))),
         hh_diff = hh_member_count - cols_w_age) %>%
  #Removing households that did not report the age of each member
  filter(hh_diff < 1) %>%
  #Calculating the age of eldest individual
  rowwise() %>% mutate(max_age = max(c(age_hh_memb_i, 
                                       age_hh_memb_000, age_hh_memb_001, age_hh_memb_002, age_hh_memb_003,
                                       age_hh_memb_004, age_hh_memb_005, age_hh_memb_006, age_hh_memb_006,
                                       age_hh_memb_007, age_hh_memb_008, age_hh_memb_009, age_hh_memb_010,
                                       age_hh_memb_011, age_hh_memb_012, age_hh_memb_013, age_hh_memb_014),
                                     na.rm = TRUE)) %>% ungroup() %>%
  #Ordering by household size and age of eldest
  arrange(hh_member_count, max_age) %>%
  #Giving a rank for plotting (index_hh) that restarts at 1 for each household size
  group_by(hh_member_count) %>% mutate(index_hh = 1:length(index)) %>% ungroup() %>%
  #Melting so each individual is on a row
  melt(id.vars = c("index", "index_hh", "age", "gender", "region", "acad", "nb_room", "hh_member_count", "close_contact",
                   "pers_per_room", "cols_w_age", "hh_diff", "max_age")) %>%
  #For plotting with a different color, adding a marker for individuals 65 and older
  mutate(old = as.factor(ifelse(max_age > 64, 1, 0))) %>%
  #Deleting rows with incomplete data
  drop_na()
```

(plotting the household size distribution)

```{r 6.02, fig.height=7, fig.width=10, echo=FALSE}
#Highlighting households with individuals over 65
p.hhc <- df.hhc %>% ggplot(aes(x = value, y = index_hh, color = old)) +
  geom_point() +
  #Separating each household size
  facet_grid(~ hh_member_count, scales = "fixed") +
  xlab("Age of household members") + ylab("Household") +
  scale_color_manual(values = c("black", "#c51162"), 
                     labels = c("Housholds with 0 individuals > 65   ", "Households with 1+ individual > 65")) +
  theme_bw() +
  scale_y_continuous(breaks = c(1:max(df.hhc$index_hh)+1)) +
  rremove("y.text") +
  labs(
    title    = "Age distribution of households in Analamanga region, Madagascar",
    subtitle = paste0("n = ", length(unique(df.hhc$index)), " households",
                      "\nSeparated into panels by household size; Each row shows one household of the specified size"),
    caption  = "Households containing Madagascar STEM student or professional",
    color = "") + 
  theme(legend.position = "top")

p.hhc
```

(plotting the histogram of the number of individuals per room)

```{r 6.03, fig.height=7, fig.width=10, echo=FALSE}
#Keeping the pers_per_room from the melted df.hhc
df.hhc %>% group_by(index) %>% summarize(pers_per_room = max(pers_per_room), .groups = "drop") %>%
  ggplot(aes(x = pers_per_room)) +
  geom_histogram(binwidth=1, fill = "#00695c") + 
  xlab("Number of individuals per room in the house \n (excluding bathrooms and kitchen)") +
  ylab("Count") + theme_bw()
```



