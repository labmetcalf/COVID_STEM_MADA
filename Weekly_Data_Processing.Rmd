---
title: "Weekly_Data_Processing"
author: "Benny Rice"
date: "2/8/2021"
output: html_document
---

```{r setup, include = FALSE, eval = TRUE, echo = TRUE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
```

***
***
<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

## HEADER INFO

- Benny Rice | Department of Ecology and Evolutionary Biology | Princeton University | b.rice@princeton.edu
- Code associated with processing data from the **Impacts of Covid-19 on Malagasy STEM** project
- Apologies in advance for amateurish code (ie all the loops and clunkiness)
- In colloboration with Lova Marline, Miary Raselimanana, Seheno Andriantsaralaza, Hervet Randriamady

</div>

***

(Set up: Loading necessary libraries)
```{r i1, message = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(ggplot2)
library(reshape2)
library(ggpubr)
library(ggalt)
library(ggrepel)
library(here)
library(gridExtra)
library(readxl)
```

***
***

#### OUTLINE:

- Section 1:
- Section 2:
- Section 3:
- Section 4:
- Section 5:


**FIX** Update outline at the end (add figures and tables interspersed ^)


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 1 | Reading in data downloaded from Kobo Collect (xls form, English)

</div>

***
***

- Data is read from an xlsx file that is manually downloaded from the Kobo Collect account
  - Selecting export options:
    - Export type `XLS`
    - Value and header format `XML values and headers`
    - Do not select `Include fields from all 24 deployed versions`
  - Manually uploading to [the GitHub repository for this project](https://github.com/labmetcalf/COVID_STEM_MADA)
- Data file name should include the data at which data was downloaded

```{r 1.01}
k.data <- read_xlsx(here("DATA_01_Impacts_of_Covid-19_on_Malagasy_STEM_-_latest_version_-_False_-_2021-02-09-03-17-57.xlsx"))
```

- Previewing data

```{r 1.02}
kable(k.data, caption = "Table 1.02: Raw Data") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 7) %>% scroll_box(width = "100%", height = "300px")
```


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 2 | Progress: Summary stats on sample size

</div>

***
***

- Summary of sampling progress listed:

```{r 2.01, echo = FALSE}
paste0("Dates of surveys completed: ")
paste0(unique(k.data$today))
paste0("Number of surveys completed (n) = ", length(k.data$agreement[k.data$agreement == "yes"]))
paste0("Number of surveys completed, female = ", 
       length(k.data$agreement[k.data$agreement == "yes" & k.data$gender == "female"]))
paste0("Number of surveys completed, male  = ", 
       length(k.data$agreement[k.data$agreement == "yes" & k.data$gender == "male"]))
paste0("Number of surveys completed, nonbinary gender = ", 
       length(k.data$agreement[k.data$agreement == "yes" & k.data$gender == "other_notsay"]))
paste0("Average number of surveys performed per day of sampling = ",
       length(k.data$agreement[k.data$agreement == "yes"])/length(unique(k.data$today)))
```

- Summary of sampling progress, time series plot:
```{r 2.02, echo = FALSE}
p.gender_summary1 <- k.data %>% select(agreement, today, gender) %>% group_by(today) %>% 
  summarize(n = length(today), .groups = "drop") %>% 
  ggplot(aes(x = today, y = n)) +
  geom_bar(stat='identity', width=0.8) +
  xlab("Date") + labs(subtitle = "Sampling by day") +
  theme_bw()

p.gender_summary2 <- k.data %>% select(agreement, today, gender) %>% group_by(today) %>% 
  count(gender) %>% ungroup() %>%
  ggplot(aes(x = today, y = n, fill = gender)) +
  geom_bar(stat='identity', width=0.8) +
  xlab("Date") + labs(subtitle = "Sampling by day and gender") +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "right")

p.gender_summary3 <- k.data %>% select(agreement, today, gender) %>% group_by(today) %>% 
  summarize(n = length(today), .groups = "drop") %>% 
  mutate(n_cum = cumsum(n)) %>%
  ggplot(aes(x = today, y = n_cum)) +
  geom_bar(stat='identity', width=0.8, fill = "#ff6f00") +
  xlab("Date") + labs(subtitle = "Cumulative Sampling by day") +
  theme_bw()
```

```{r 2.03, fig.height = 7, fig.width = 10}
grid.arrange(p.gender_summary1, p.gender_summary2, nrow = 1)
```

```{r 2.04, fig.height = 7, fig.width = 5}
p.gender_summary3
```


***
***

<style>
div.green { background-color:#d1ebd6; border-radius: 5px; padding: 10px;}
</style>
<div class = "green">

### Section 3 | Breakdown by gender

</div>

***
***

Research activity affects by gender
```{r 3.01, echo = FALSE}
p.301a <- k.data %>% select(gender, fieldwork_affect:editpeer_affect) %>%
  filter(gender != "other_notsay") %>% 
  group_by(gender) %>% count(fieldwork_affect) %>% ungroup() %>%
  mutate(fieldwork_affect = factor(fieldwork_affect, 
                                   levels = rev(c("na", "slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = fieldwork_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on fieldwork by gender (with NAs)") + xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "right")

p.301b <- k.data %>% select(gender, fieldwork_affect:editpeer_affect) %>%
  filter(gender != "other_notsay") %>% 
  group_by(gender) %>% count(writ_affect) %>% ungroup() %>%
  mutate(writ_affect = factor(writ_affect, 
                              levels = rev(c("na","nochangeaffect",  "slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = writ_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on writing by gender (with NAs)") + xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d() +
  theme_bw() +
  theme(legend.position = "right")

p.301c <- k.data %>% select(gender, fieldwork_affect:editpeer_affect) %>%
  filter(gender != "other_notsay") %>% 
  group_by(gender) %>% count(fieldwork_affect) %>% ungroup() %>%
  filter(fieldwork_affect != "na") %>%
  mutate(fieldwork_affect = factor(fieldwork_affect, 
                                   levels = rev(c("slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = fieldwork_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on fieldwork by gender (without NAs)") + xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d(option = "magma") +
  theme_bw() +
  theme(legend.position = "right")

p.301d <- k.data %>% select(gender, fieldwork_affect:editpeer_affect) %>%
  filter(gender != "other_notsay") %>% 
  group_by(gender) %>% count(writ_affect) %>% ungroup() %>%
  filter(writ_affect != "na") %>%
  mutate(writ_affect = factor(writ_affect, 
                              levels = rev(c("na","nochangeaffect",  "slightaffect", "modaffect", "veryaffect")))) %>%
  ggplot(aes(x = gender, y = n, fill = writ_affect)) +
  geom_bar(position="fill", stat='identity', width=0.8) +
  labs(subtitle = "Affects on writing by gender (without NAs") + xlab("Sex") + ylab("Proportion") +
  scale_fill_viridis_d(option = "magma") +
  theme_bw() +
  theme(legend.position = "right")
```


```{r 3.02, fig.height=7, fig.width=10}
grid.arrange(p.301a, p.301b, nrow = 1)
```

```{r 3.03, fig.height=7, fig.width=10}
grid.arrange(p.301c, p.301d, nrow = 1)
```
















